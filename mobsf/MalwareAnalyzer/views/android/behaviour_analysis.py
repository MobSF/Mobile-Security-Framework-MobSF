# -*- coding: utf_8 -*-
"""Perform behaviour analysis."""
import logging
from pathlib import Path

from django.conf import settings

from mobsf.MobSF.utils import (
    append_scan_status,
    get_android_src_dir,
)
from mobsf.StaticAnalyzer.views.sast_engine import (
    scan,
)

logger = logging.getLogger(__name__)


def analyze(checksum, app_dir, typ):
    """Perform behaviour analysis."""
    try:
        root = Path(settings.BASE_DIR) / 'MalwareAnalyzer' / 'views'
        rules = root / 'android' / 'rules' / 'behaviour_rules.yaml'
        app_dir = Path(app_dir)
        src = get_android_src_dir(app_dir, typ)
        skp = settings.SKIP_CLASS_PATH
        msg = 'Android Behaviour Analysis Started'
        logger.info(msg)
        append_scan_status(checksum, msg)
        # Behaviour Analysis
        findings = scan(
            checksum,
            rules.as_posix(),
            {'.java', '.kt'},
            [src.as_posix() + '/'],
            skp)
        msg = 'Android Behaviour Analysis Completed'
        logger.info(msg)
        append_scan_status(checksum, msg)
        return findings
    except Exception as exp:
        msg = 'Failed to perform behaviour analysis'
        logger.exception(msg)
        append_scan_status(checksum, msg, repr(exp))
    return {}
