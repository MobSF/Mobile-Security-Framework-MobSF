
{% extends "base/base_layout.html" %}
{% load static %}
 {% block sidebar_option %}
      sidebar-collapse
{% endblock %}
 {% block extra_css %}
<link href="{% static "adminlte/plugins/sweetalert2/sweetalert2.min.css" %}" rel="stylesheet">

<style>
#app_icon {
    width: 64px;
    height: 64px;
}
.selected {
    background-color: lightgreen !important;
}

.selectable_table tr:hover {
    background-color: lightgreen !important;
}

.fa.disabled,
.fa[disabled],
.disabled > .fa,
[disabled] > .fa {
  opacity: 0.5;
  cursor: not-allowed;
}
</style>
{% endblock %}
{% block content %}
<div class="content-wrapper">
  <div class="content-header">
  </div>
   <div class="container-fluid">
        <div class="row">
            <div class="col-lg-12">
            <div class="card">
              <div class="card-body">
                

                 <div class="box">
        <div class="box-header with-border">
            <h3 class="box-title"><i class="fa fa-rocket"></i> Recent Scans</h3>
        </div>

        <div class="box-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover table-striped">
                    <thead>
                    <tr>
                        <th>SCAN DATE</th>
                        <th>APPLICATION</th>
                        <th>FILE</th>
                        <th>TYPE</th>
                        <th>SCAN ID {% if is_admin %} / SUBMITTER{% endif %}</th>                        
                        <th style="width: 15%">ACTIONS</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for e in entries %}
                        <tr>
                            <td><span class="scandate">{{ e.TIMESTAMP|date:'c' }}</span></td>
                            <td align="center">
                                <strong>{{e.USER_APP_NAME}} - {{e.USER_APP_VERSION}}</strong></br>
                                <img id="app_icon" src="/download/{{ e.MD5 }}-icon.png" onerror="this.src='{% static 'img/no_icon.png' %}'">
                                {% if e.PACKAGE_NAME %}
                                  <br/>{{ e.APP_NAME }} {% if e.VERSION_NAME %} - {{ e.VERSION_NAME }} {% endif %}
                                  </br>{{ e.PACKAGE_NAME }}                                 
                                {% else %}
                                  {% if e.ERROR %}
                                    </br><span class="badge bg-danger">scan error</span>
                                  {% else %}
                                    </br><span class="badge bg-warning">scan in progress</span>
                                  {% endif %}
                                {% endif %}
                            </td>
                            <td>{{ e.FILE_NAME }}
                            </td>
                            <td align="center">
                                {% if '.apk' == e.FILE_NAME|slice:"-4:"%}<i class="fab fa-android fa-3x"></i>
                                {% elif '.xapk' == e.FILE_NAME|slice:"-5:"%}<i class="fab fa-android fa-3x"></i>
                                {% elif '.apks' == e.FILE_NAME|slice:"-5:"%}<i class="fab fa-android fa-3x"></i>
                                {% elif '.ipa' == e.FILE_NAME|slice:"-4:"%}<i class="fab fa-apple fa-3x"></i>
                                {% elif '.zip' == e.FILE_NAME|slice:"-4:"%}<i class="fas fa-file-archive fa-3x"></i>
                                {% elif '.appx' == e.FILE_NAME|slice:"-5:"%}<i class="fab fa-windows fa-3x"></i>
                                {% endif %}
                            </td>                            
                            <td>{{ e.MD5 }}
                                {% if is_admin %}
                                    <br/><br/><label id="scanEmails" text="{{ e.EMAIL }}"/>
                                    <input type="text" id="scanEmailsInput{{e.MD5}}" text="{{ e.EMAIL }}" hidden/>
                                {% endif %}
                            </td>                               
                            <td><p>                                    
                                    {% if e.PACKAGE_NAME %}
                                        {% if is_admin %}
                                            <a class="btn btn-outline-primary btn-sm" id="admin_edit" onclick="show_admin_save({{e.MD5}})" href="#"><i class="fas fa-pencil-square-o" title="Edit"></i></a>
                                            <a class="btn btn-outline-primary btn-sm" id="admin_save" onclick="update_emails({{e.MD5}})" href="#" hidden><i class="fas fa-floppy-disk" title="Save"></i></a>
                                        {% endif %}
                                    <a class="btn btn-primary btn-sm" style="margin-bottom: 3px; width: 125px;" href="../{{ e.ANALYZER }}/?name={{e.FILE_NAME}}&amp;checksum={{e.MD5}}&amp;type={{e.SCAN_TYPE}}"><i class="fas fa-eye" title="View static analysis details"></i> Static Details</a><br/>
                                    <a class="btn btn-primary btn-warning btn-sm" style="margin-bottom: 3px;  width: 125px;" href="../appsec_dashboard/{{ e.MD5 }}/"><i class="fas fa-user-shield" title="View security scorecard"></i> Scorecard</a><br/>
                                    <a class="btn btn-primary btn-sm" style="width: 125px;" href="{{dependency_track_url}}/projects/?tag={{ e.MD5 }}"><i class="fas fa-link" title="View third party dependency details"></i> Dependencies</a><br/>
                                        {% if is_admin %}
                                            {% if e.RELEASE %}<a class="btn btn-outline-primary btn-sm" id="admin_release" onclick="toggle_release({{e.MD5}}, false)" href={% if e.isWithin30Days() %}"#"{% endif %} {% if not e.iswithin30days() %}disabled{% endif %} ><i class="fas fa-check" title="Remove Release"></i></a>
                                            {% else %}<a class="btn btn-outline-primary btn-sm" id="admin_release" onclick="toggle_release({{e.MD5}}, true)" href={% if e.isWithin30Days() %}"#"{% endif %} {% if not e.iswithin30days() %}disabled{% endif %}><i class="fas fa-check" title="Set Release"></i></a>
                                            {% endif %}
                                        {% endif %}
                                    {% endif %}
                                </p><p>
                                    {% if e.PACKAGE_NAME %}
                                        <a class="btn btn-outline-primary btn-sm" href="../pdf/?md5={{ e.MD5 }}"><i class="fas fa-file-pdf" title="View PDF report of static analysis details"></i></a>
                                        <!--<a class="btn btn-outline-info btn-sm" href="../pdf-sbom/?md5={{ e.MD5 }}"><i class="fas fa-file-pdf" title="View PDF report of third party dependency details"></i></a>-->
                                        <!--<a class="btn btn-outline-primary btn-sm" href="../{{ e.ANALYZER }}/?name={{e.FILE_NAME}}&amp;checksum={{e.MD5}}&amp;type={{e.SCAN_TYPE}}&amp;rescan=1"><i class="fas fa-sync-alt" title="Perform another static analysis scan"></i></a>-->
                                        <!--{% if '.apk' == e.FILE_NAME|slice:"-4:" or '.xapk' == e.FILE_NAME|slice:"-5:" or '.apks' == e.FILE_NAME|slice:"-5:"%}
                                        <a class="btn btn-outline-primary btn-sm diffButton" id="{{ e.MD5 }}_{{ e.FILE_NAME }}" href="#"><i class="fas fa-not-equal" title="Compare this scan with another one"></i></a>
                                        {% endif %}-->
                                    {% endif %}
                                    <a class="btn btn-outline-primary btn-sm" id="{{ e.MD5 }}" onclick="delete_scan(this)" href="#"><i class="fas fa-trash" title="Delete this scan"></i></a>
                                </p>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <!-- /.box-body -->
    </div>


          </div>
        </div>
       </div>
     </div>
    </div>
</div>
{% endblock %}
{% block extra_scripts %}
<script src="{% static "adminlte/plugins/sweetalert2/sweetalert2.min.js" %}"></script>
<script src="{% static "others/js/dayjs.min.js" %}"></script>
<script>
    // Diff functions
    var diff_first_md5 = '';
    var diff_first_name = '';

    // When a row is clicked, we check if we already have first scan, if so, ask for confirmation
    function enable_partner_select() {
        $('table tr').on('click', function (e) {
            e.preventDefault();
            if (diff_first_md5 == '') {
                return;
            }
            diff_confirmation($(this));
        })
    }

    function enable_diff_button(){
        $(".diffButton").on('click', function(e){
            e.stopPropagation();
            diff_select($(this));
        });
    }

    function disable_diff_button() {
        $('.diffButton').off('click');
    }

    // First pop up only saves the first scan to diff and tells the user to select a partner
    function diff_select(item) {

        Swal.fire({
            title: '<strong>Select App to Compare</strong>',
            type: 'info',
            text: 'Please select the second scan result for comparison',
            timer: 10000
        });
        diff_first_md5 = item.attr('id').slice(0, 32);
        diff_first_name = item.attr('id').slice(33);
        item.closest("tr").addClass("selected");
        item.closest("tbody").addClass("selectable_table");

        // Enable the second partner selection
        enable_partner_select();
        disable_diff_button();
    }

    function diff_cleanup() {
        first_td_id = diff_first_md5 + '_' + diff_first_name;
        $('[id="' + first_td_id + '"]').closest("tr").removeClass("selected");
        $('[id="' + first_td_id + '"]').closest("tbody").removeClass("selectable_table");
        diff_first_md5 = "";
        diff_first_name = "";
        enable_diff_button();
    }

    // Here we get jquery row
    function diff_confirmation(item) {
        // First we need the id which has the md5 and name
        rows_tds = item.find('td');
        selected_md5 = rows_tds[3].innerText;
        if (diff_first_md5 == selected_md5) {
            return;
        }
        diff_second_md5 = selected_md5;
        diff_second_name = rows_tds[1].innerText;

        Swal.fire({
            title: '<strong>Diff confirmation</strong>',
            type: 'info',
            html:
                '<strong>Do you want to diff - </strong><br />' + diff_first_name +
                '<br /> <strong>with - <br /> </strong>' + diff_second_name + ' <br /> <strong>?</strong>',

            showCancelButton: true,
            cancelButtonText: 'Cancel',
            confirmButtonText: 'Start Diffing!',
        }).then((result) => {
            if (result.value) {
                window.location = '/compare/' + diff_first_md5 + '/' + diff_second_md5 + '/';
            } else {
                 diff_cleanup();
            }
        })
    }

    function delete_scan(item){
      Swal.fire({
      title: 'Are you sure?',
      text: "This will permanently remove the scan results",
      type: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Yes',
      cancelButtonText: 'No',
      confirmButtonColor: '#d33',
      cancelButtonColor: '#2da532',
    }).then((result) => {
        if (result.value) {
            var md5_hash = item.id;
            $.ajax({
                    url: '../delete_scan/',
                        type : 'POST',
                    dataType: 'json',
                        data : {
                                csrfmiddlewaretoken: '{{ csrf_token }}',
                                md5: md5_hash,
                                },
                            success : function(json) {
                                if (json.deleted==='yes'){
                                    Swal.fire(
                                        'Deleted!',
                                        'The scan result is deleted!',
                                        'success'
                                    ).then(function () {
                                        location.reload();
                                    })
                                }
                                else {
                                    Swal.fire(
                                    'Delete Failed',
                                    'Cannot delete the scan result!',
                                    'error'
                                    )
                                }
                            },
                            error : function(xhr,errmsg,err) {
                                Swal.fire(
                                    'Delete Failed',
                                    errmsg,
                                    'error'
                                    )
                            }
                });
               
        } else {
                diff_cleanup();
        }
        });
    }

    function show_admin_save(item){
        var inputName = "#scanEmailsInput" + item;
        $('#admin_edit').prop('hidden', true);
        $('#scanEmails').prop('hidden', true);
        $(inputName).prop('hidden', false);
        $('#admin_save').prop('hidden', false);
    }

    function reset_admin_save(item){
        var inputName = "#scanEmailsInput" + item;
        $(inputName).prop('hidden', true);
        $('#scanEmails').prop('hidden', false);
        $('#admin_edit').prop('hidden', false);
        $('#admin_save').prop('hidden', true);
    }

    function getCleanEmails(identifier){
        var retVal = "";
        var inputName = "#scanEmailsInput" + identifier;
        var emails = $(inputName).val();
        var updated = emails.replace(/,/gi, ";");
        var emailArray = updated.split(";");
        eamilArray.forEach(cleanElement);
        for(var i = 0; i < emailArray.length; i++){
            if(i < emailArray.length - 1){
                retVal += emailArray[i] + ",";
            } else {
                retVal += emailArray[i];
            }
        }
        return retVal;
    }

    function cleanElement(item, index, arr){
        if(item.indexOf("<") != -1 && item.indexOf(">") != -1){
            arr[index] = item.substring(item.indexOf("<")+1, item.indexOf(">"));
        } 
    }



    function toggle_release(item, flag){
        Swal.fire({
        title: 'Are you sure?',
        text: if(flag){"This will remove the scan as a release version"}else{"This will set the scan as a release version"},
        type: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes',
        cancelButtonText: 'No',
        confirmButtonColor: '#d33',
        cancelButtonColor: '#2da532',
      }).then((result) => {
          if (result.value) {
              var md5_hash = item;
              var newRelease = flag;
              $.ajax({
                      url: '../update_scan/',
                          type : 'POST',
                      dataType: 'json',
                          data : {
                                  csrfmiddlewaretoken: '{{ csrf_token }}',
                                  md5: md5_hash,
                                  release: newRelease
                                  },
                              success : function(json) {
                                  if (json.updated ==='yes'){
                                      Swal.fire(
                                          'Updated!',
                                          'The scan has been updated!',
                                          'success'
                                      ).then(function () {
                                          location.reload();
                                      })
                                  }
                                  else {
                                      Swal.fire(
                                      'Release update Failed',
                                      'Cannot update the scan!',
                                      'error'
                                      )
                                  }
                              },
                              error : function(xhr,errmsg,err) {
                                  Swal.fire(
                                      'Updating scan Failed',
                                      errmsg,
                                      'error'
                                      )
                              }
                  });
                 
          } //else {
            //      diff_cleanup();
          //}
          });
      }

      function update_emails(item){
        Swal.fire({
        title: 'Are you sure?',
        text: "This will update the notification emails for this scan",
        type: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes',
        cancelButtonText: 'No',
        confirmButtonColor: '#d33',
        cancelButtonColor: '#2da532',
      }).then((result) => {
          if (result.value) {
              var md5_hash = item;
              var emails = getCleanEmails(md5_hash);
              $.ajax({
                      url: '../update_scan/',
                          type : 'POST',
                      dataType: 'json',
                          data : {
                                  csrfmiddlewaretoken: '{{ csrf_token }}',
                                  md5: md5_hash,
                                  email: emails
                                  },
                              success : function(json) {
                                  if (json.deleted==='yes'){
                                      Swal.fire(
                                          'Updated!',
                                          'The email addresses have been updated!',
                                          'success'
                                      ).then(function () {
                                          reset_admin_save();
                                          location.reload();
                                      })
                                  }
                                  else {
                                      Swal.fire(
                                      'Email update Failed',
                                      'Cannot update the emails!',
                                      'error'
                                      )
                                  }
                              },
                              error : function(xhr,errmsg,err) {
                                  Swal.fire(
                                      'Updating emails Failed',
                                      errmsg,
                                      'error'
                                      )
                              }
                  });
                 
          } else {
                  reset_admin_save(item);
          }
          });
      }

  
    $(document).ready(function() {
        enable_diff_button(); 

        if ($("span.badge.bg-warning").length > 0) {
            window.setTimeout(function() {
                window.location.reload();
            }, 30000);
        }

        $("span.scandate").each(function() {
            this.innerText = dayjs(this.innerText).format("MMM D, YYYY h:mm A")
        });
    });

</script>

{% endblock %}