# -*- coding: utf_8 -*-
import os
import logging
from django.conf import settings
from MobSF.utils import filename_from_path

logger = logging.getLogger(__name__)


def apkid_analysis(app_dir, apk_file):
    """APKiD Analysis of DEX files"""
    apkid_res = {}
    if not settings.APKID_ENABLED:
        return apkid_res
    if not os.path.exists(apk_file):
        logger.error("APKiD - APK not found")
        return {'error': True}
    from apkid import apkid
    from apkid import __version__ as apkid_ver
    logger.info("Running APKiD %s on: %s", apkid_ver,
                filename_from_path(apk_file))
    result = apkid.scan_apk(apk_file, 30, True)
    for filep, res in result.items():
        dex_file = filep.rsplit("!", 1)[1]
        apkid_res[dex_file] = res
    return apkid_res
