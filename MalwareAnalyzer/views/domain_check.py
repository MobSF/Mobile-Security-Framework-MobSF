# -*- coding: utf_8 -*-
# Module for Malware Analysis
import io
import logging
import os
import re
from urllib.parse import urlparse

from django.conf import settings

from MobSF.utils import (is_internet_available,
                         update_local_db)

logger = logging.getLogger(__name__)

# PATH
MALWARE_DB_DIR = settings.SIGNATURE_DIR


def update_malware_db():
    """Check for update in malware DB."""
    try:
        mal_db = os.path.join(MALWARE_DB_DIR, 'malwaredomainlist')
        resp = update_local_db('Malware', settings.MALWARE_DB_URL, mal_db)
        if (resp):
            # DB needs update
            # Check2: DB Syntax Changed
            line = resp.decode('utf-8', 'ignore').split('\n')[0]
            lst = line.split('",')
            if len(lst) == 10:
                # DB Format is not changed. Let's update DB
                logger.info('Updating Malware Database....')
                with open(mal_db, 'wb') as wfp:
                    wfp.write(resp)
            else:
                logger.info('Malware Database format from '
                            'malwaredomainlist.com has changed.'
                            ' Database is not updated. '
                            'Please report to: https://github.com/'
                            'MobSF/Mobile-Security-Framework-MobSF/issues')
    except Exception:
        logger.exception('[ERROR] Malware DB Update')


def malware_check(urllist):
    result = {}
    try:
        if not settings.DOMAIN_MALWARE_SCAN:
            logger.info('Domain Malware Check disabled in settings')
            return result
        if is_internet_available():
            update_malware_db()
        else:
            logger.warning('No Internet Connection. '
                           'Skipping Malware Database Update.')
        domainlist = get_domains(urllist)
        if not domainlist:
            return result
        mal_db = os.path.join(MALWARE_DB_DIR, 'malwaredomainlist')
        with io.open(mal_db,
                     mode='r',
                     encoding='utf8',
                     errors='ignore') as flip:
            entry_list = flip.readlines()
        for entry in entry_list:
            enlist = entry.split('","')
            if len(enlist) > 5:
                details_dict = {}
                details_dict['domain_or_url'] = enlist[1]
                details_dict['ip'] = enlist[2]
                details_dict['desc'] = enlist[4]
                details_dict['bad'] = 'yes'
                dmn_url = details_dict['domain_or_url']
                for domain in domainlist:
                    dmn_neturl = get_netloc(dmn_url)
                    if (((dmn_neturl == domain or dmn_neturl == domain[4:])
                            and (len(dmn_url) > 1))
                            or details_dict['ip'].startswith(domain)):
                        result[domain] = details_dict
        # Good Domains
        for domain in domainlist:
            if domain not in result:
                tmp_d = {}
                tmp_d['bad'] = 'no'
                result[domain] = tmp_d
    except Exception:
        logger.exception('[ERROR] Performing Malware Check')
    return result

# Helper Functions


def verify_domain(checkeddom):
    try:
        if (len(checkeddom) > 2
                and '.' in checkeddom
                and (checkeddom.endswith('.') is False
                     and re.search('[a-zA-Z0-9]', checkeddom))):
            return True
        else:
            return False
    except Exception:
        logger.exception('[ERROR] Verifying Domain')


def get_netloc(url):
    """Get Domain."""
    try:
        domain = ''
        parsed_uri = urlparse(url)
        if not urlparse(url).scheme:
            url = '//' + url
            parsed_uri = urlparse(url)
            domain = '{uri.netloc}'.format(uri=parsed_uri)
        if verify_domain(domain):
            return domain
    except Exception:
        logger.exception('[ERROR] Extracting Domain form URL')


def get_domains(urls):
    """Get Domains."""
    try:
        domains = []
        for url in urls:
            parsed_uri = urlparse(url)
            if not urlparse(url).scheme:
                url = '//' + url
                parsed_uri = urlparse(url)
            domain = '{uri.netloc}'.format(uri=parsed_uri)
            if (domain not in domains
                    and verify_domain(domain)):
                domains.append(domain)
        return domains
    except Exception:
        logger.exception('[ERROR] Extracting Domain form URL')
