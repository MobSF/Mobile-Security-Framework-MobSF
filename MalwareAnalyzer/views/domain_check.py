# -*- coding: utf_8 -*-
# Module for Malware Analysis
import io
import logging
import os
import re
import shutil
import tempfile
from urllib.parse import urlparse

import requests

from django.conf import settings

from MobSF.utils import (is_internet_available,
                         sha256,
                         upstream_proxy)

logger = logging.getLogger(__name__)

# PATH
MALWARE_DB_DIR = TOOLS_DIR = os.path.join(
    settings.BASE_DIR, 'MalwareAnalyzer/malwaredb/')


def update_malware_db():
    """Check for update in malware DB."""
    try:
        proxies, verify = upstream_proxy('http')
    except Exception:
        logger.exception('[ERROR] Setting upstream proxy')
    try:
        url = settings.MALWARE_DB_URL
        response = requests.get(url, timeout=3, proxies=proxies, verify=verify)
        data = response.content
        tmp_dwd = tempfile.NamedTemporaryFile()
        tmp_dwd.write(data)
        mal_db = os.path.join(MALWARE_DB_DIR, 'malwaredomainlist')
        tmp_dwd.seek(0)
        # Check1: SHA256 Change
        if sha256(tmp_dwd.name) != sha256(mal_db):
            # DB needs update
            # Check2: DB Syntax Changed
            line = tmp_dwd.readline().decode('utf-8', 'ignore')
            lst = line.split('",')
            if len(lst) == 10:
                # DB Format is not changed. Let's update DB
                logger.info('Updating Malware Database....')
                shutil.copyfile(tmp_dwd.name, mal_db)
            else:
                logger.info('Malware Database format from '
                            'malwaredomainlist.com has changed.'
                            ' Database is not updated. '
                            'Please report to: https://github.com/'
                            'MobSF/Mobile-Security-Framework-MobSF/issues')
        else:
            logger.info('Malware Database is up-to-date.')
        tmp_dwd.close()
    except Exception:
        logger.exception('[ERROR] Malware DB Update')


def malware_check(urllist):
    result = {}
    try:
        if not settings.DOMAIN_MALWARE_SCAN:
            logger.info('Domain Malware Check disabled in settings')
            return result
        domainlist = get_domains(urllist)
        if not domainlist:
            return result
        if is_internet_available():
            update_malware_db()
        else:
            logger.warning(
                'No Internet Connection. Skipping Malware Database Update.')
        mal_db = os.path.join(MALWARE_DB_DIR, 'malwaredomainlist')
        with io.open(mal_db,
                     mode='r',
                     encoding='utf8',
                     errors='ignore') as flip:
            entry_list = flip.readlines()
        for entry in entry_list:
            enlist = entry.split('","')
            if len(enlist) > 5:
                details_dict = {}
                details_dict['domain_or_url'] = enlist[1]
                details_dict['ip'] = enlist[2]
                details_dict['desc'] = enlist[4]
                details_dict['bad'] = 'yes'
                dmn_url = details_dict['domain_or_url']
                for domain in domainlist:
                    if (dmn_url.startswith(domain)
                            or (domain.startswith(dmn_url, 4)
                                and (len(dmn_url) > 1))
                            or details_dict['ip'].startswith(domain)):
                        result[domain] = details_dict
        # Good Domains
        for domain in domainlist:
            if domain not in result:
                tmp_d = {}
                tmp_d['bad'] = 'no'
                result[domain] = tmp_d
    except Exception:
        logger.exception('[ERROR] Performing Malware Check')
    return result

# Helper Functions


def get_domains(urls):
    """Get Domains."""
    try:
        domains = []
        for url in urls:
            parsed_uri = urlparse(url)
            if not urlparse(url).scheme:
                url = '//' + url
                parsed_uri = urlparse(url)
            domain = '{uri.netloc}'.format(uri=parsed_uri)
            if (domain not in domains
                    and len(domain) > 2
                    and '.' in domain
                    and (domain.endswith('.') is False
                         and re.search('[a-zA-Z0-9]', domain))):
                domains.append(domain)
        return domains
    except Exception:
        logger.exception('[ERROR] Extracting Domain form URL')
